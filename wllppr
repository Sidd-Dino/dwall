#!/bin/sh
#
# wllppr

rand_str() {
    set -f

    tmp=$(dd if=/dev/urandom bs=24 count=1 status=none | base64)
    
    ifs=$IFS
    IFS='/'
    set -- $tmp
    IFS=''
    printf '%s' "$*"
    IFS=$ifs
    set +f
}

download_img() {
    # base url
    base_url="https://source.unsplash.com"

    # user stuff
    url="${base_url}${WLLPPR_USER:+/user/$WLLPPR_USER${WLLPPR_LIKED:+/likes}}"

    # featured pics
    url="${url}${WLLPPR_FEATURED:+/featured}"

    # image dimension
    url="${url}${WLLPPR_DIMENSION:+/${WLLPPR_DIMENSION}}"

    # search tags
    url="${url}${WLLPPR_SEARCH_TAGS:+/?${WLLPPR_SEARCH_TAGS}}"

    [ $url = $base_url ] && url="${url}/random"
    curl -L "$url" --output "$cache_dir/$file_name" || {
        printf '%s\n' "error: could not download the image" >&2
        exit 1
    }
}

main() {

    # create cache dir
    mkdir -p "${XDG_CACHE_HOME:=${HOME}/.cache}/wllppr"

    cache_dir="${XDG_CACHE_HOME:=${HOME}/.cache}/wllppr"
    
    [ -d "$cache_dir" ] || {
        printf '%s\n' "error: Unable to open cache folder" >&2
        exit 1
    }

    rm -- "$cache_dir"/* 2>/dev/null

    # get new file's name
    file_name="$(rand_str).jpeg"
    download_img

    wal -i "$cache_dir/$file_name" &
}

main "$@"
